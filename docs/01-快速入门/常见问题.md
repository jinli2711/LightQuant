# 常见问题

本页面收集了 LightQuant 用户在使用过程中经常遇到的问题及其解决方案。如果您在此处没有找到答案，请通过项目 Issues 页面寻求帮助。

## 安装配置问题

### Q1：安装依赖时网络超时怎么办？

安装依赖时遇到网络超时是非常常见的问题，尤其是在国内网络环境下。解决这个问题有几种方法：首先，推荐使用国内镜像源，如清华大学或阿里云的 pip 镜像。可以使用以下命令指定镜像源安装：`pip install 包名 -i https://pypi.tuna.tsinghua.edu.cn/simple`。其次，可以配置 pip 永久使用镜像源，创建或编辑 `~/.pip/pip.conf` 文件，添加镜像源配置。第三，如果某个包安装特别慢，可以尝试单独安装该包并使用镜像源。最后，对于 GitHub 上的项目，可以尝试从 Gitee 等国内镜像站点克隆。

### Q2：PyTorch 与 CUDA 版本不匹配如何解决？

CUDA 版本不匹配是深度学习开发中常见的问题。首先需要确认您的系统环境，使用 `nvidia-smi` 命令查看当前驱动支持的 CUDA 版本，使用 `nvcc --version` 查看已安装的 CUDA 工具包版本。然后访问 PyTorch 官方网站，获取与您的 CUDA 版本匹配的安装命令。请注意，PyTorch 2.0 及以上版本对 CUDA 版本有特定要求。如果版本不匹配，最简单的解决方法是重新安装正确版本的 PyTorch。如果您的 GPU 驱动较旧，可能需要升级驱动或安装较旧版本的 CUDA 工具包。

### Q3：Windows 上找不到 Python 命令怎么办？

如果在命令行中输入 `python` 提示"找不到命令"，通常是因为 Python 未添加到系统 PATH 环境变量中。解决方法如下：如果使用 Anaconda，请使用 Anaconda Prompt 或激活 conda 环境；如果安装时未勾选添加到 PATH，可以重新运行安装程序并勾选此选项；也可以手动将 Python 安装路径添加到系统 PATH 环境变量中，路径通常为 `C:\Users\{用户名}\AppData\Local\Programs\Python\Python310\`（版本号可能不同）。

### Q4：Docker 环境中 GPU 不可用如何解决？

在 Docker 中使用 GPU 需要正确配置 NVIDIA Container Toolkit。首先确认已安装 NVIDIA 驱动，然后安装 NVIDIA Container Toolkit。Ubuntu 系统的安装命令如下：添加软件源、设置 GPG 密钥、安装 nvidia-container-toolkit 包、重启 Docker 服务。对于不同操作系统，具体的安装步骤有所不同，请参考 NVIDIA Container Toolkit 官方文档。启动容器时需要添加 `--gpus all` 参数来启用 GPU 支持。

### Q5：导入模块时提示 ModuleNotFoundError 怎么办？

这个错误表示 Python 找不到指定的模块。首先检查包是否已安装：`pip list | grep 包名`。如果未安装，使用 `pip install 包名` 安装。如果已安装但仍无法导入，可能是虚拟环境问题，确保在正确的环境中运行脚本。也可以尝试重新安装包：`pip uninstall 包名 && pip install 包名`。如果是刚安装的新包，可能需要重启 Python 解释器。

## 数据处理问题

### Q6：数据集下载后应该放在哪个目录？

数据集应解压到项目根目录下的 `dataset` 文件夹中。完整的数据集目录结构应如下：`dataset/CSMD50/price/` 存放价格数据 CSV 文件；`dataset/CSMD50/news/` 存放新闻数据；`dataset/CSMD50/news_embedding/` 存放新闻嵌入文件。确保所有文件和文件夹的名称与上述结构一致，否则程序将无法正确找到数据。

### Q7：如何准备自定义数据集？

准备自定义数据集需要遵循项目规定的数据格式。价格数据 CSV 文件应包含以下列：Date（日期，格式为 YYYY-MM-DD）、Open（开盘价）、High（最高价）、Low（最低价）、Close（收盘价）、Adj Close（调整后收盘价）。新闻数据 CSV 文件应包含：time（时间）、title（标题）、content（内容）。所有文件应使用 UTF-8 编码。自定义数据集准备好后，放置在与 CSMD 数据集相同的目录结构中即可使用。

### Q8：数据中存在缺失值如何处理？

项目提供了自动处理缺失值的功能。在运行 `python utils/util.py` 时，脚本会自动检测和处理缺失值。处理方法包括：线性插值填充，适用于连续数据的中间缺失；前向填充和后向填充，适用于数据开头或结尾的缺失。如果您的数据有特殊格式的缺失值（如用特定字符串表示），可能需要手动预处理。建议在训练前先运行数据检查：`python utils/util.py --dataset 您的数据集 --check_only`。

### Q9：如何生成新闻文本的词向量嵌入？

词向量嵌入是使用多模态模型的前提条件。运行以下命令生成嵌入：`python utils/word2vec.py --dataset CSMD50 --csv_news_path ./dataset/CSMD50/news/ --embedding_path ./dataset/CSMD50/news_embedding/`。此脚本会遍历所有新闻数据，使用预训练模型生成词向量表示，并保存为 `.npy` 格式。生成过程可能需要较长时间，取决于数据量和 GPU 性能。如果遇到内存问题，可以尝试减小批量大小或分批处理。

### Q10：训练集、验证集和测试集是如何划分的？

数据集按照时间顺序进行划分：训练集包含 2021-01-01 到 2024-03-14 的数据；验证集包含 2024-03-15 到 2024-08-07 的数据；测试集包含 2024-08-08 到 2024-12-31 的数据。这种划分方式模拟了真实的时间序列预测场景，确保训练数据不会"泄露"到测试集中。您可以通过修改 `utils/util.py` 中的日期配置来调整划分比例。

## 模型训练问题

### Q11：训练时 GPU 内存不足怎么办？

GPU 内存不足是常见问题，尤其在使用大批量大小或复杂模型时。解决方法包括：减小 batch_size 参数，推荐从 32 或 16 开始尝试；启用梯度累积，在保持有效批量大小的同时减少内存占用；使用混合精度训练，在 `run.py` 中启用 AMP 选项可以减少约一半的显存占用；减小模型复杂度，如降低 hidden_size 或减少网络层数；如果有多张 GPU，可以使用多 GPU 并行训练分摊内存压力。

### Q12：训练损失不下降怎么办？

训练损失不下降可能由多种原因引起。首先检查学习率，过高或过低的学习率都会导致收敛问题，建议从默认学习率 3e-4 开始尝试。其次检查数据是否正确预处理，确保数据已标准化且标签生成正确。第三尝试使用不同的优化器或调整优化器参数。第四检查模型是否适用于您的数据规模，对于较小的数据集可能需要使用较简单的模型。第五确保没有数据泄露，验证集和测试集不应包含训练时间段的数据。

### Q13：如何选择合适的模型？

模型选择取决于多个因素：数据规模方面，较小的数据集适合使用简单的 LSTM 或 BiLSTM 模型；较大的数据集可以尝试 HAN 或 StockNet 等复杂模型。预测目标方面，短期预测适合使用局部特征捕捉能力强的模型；长期预测可能需要注意力机制来关注更长时间范围的信息。计算资源方面，资源有限时选择轻量级模型；资源充足时可以尝试多个模型进行对比。最终建议通过实验比较不同模型在验证集上的表现，选择最适合您具体场景的模型。

### Q14：如何调整模型超参数？

主要的超参数及其建议范围如下：学习率（lr）建议范围为 1e-5 到 1e-3，推荐从 3e-4 开始尝试；批量大小（batch_size）建议范围为 16 到 128，需要根据 GPU 内存调整；回看窗口（look_back_window）建议范围为 3 到 20，推荐 7 或 14；隐藏层大小（hidden_size）建议范围为 64 到 256；训练轮数（epochs）建议范围为 50 到 300，建议配合 Early Stopping 使用。调参时建议使用网格搜索或随机搜索，在验证集上评估不同参数组合的效果。

### Q15：如何恢复中断的训练？

LightQuant 支持从检查点恢复训练。在训练过程中，模型会定期保存检查点到 `--model_save_folder` 指定的目录。要恢复训练，需要在运行命令时添加 `--resume_from` 参数并指定检查点文件路径。或者手动加载模型权重：`model.load_state_dict(torch.load('checkpoint.pth'))`。确保恢复训练时的参数设置与保存检查点时一致，否则可能导致意外行为。

### Q16：训练过程中如何监控模型性能？

LightQuant 使用 SwanLab 进行实验监控。训练过程中，您可以在 SwanLab 控制台实时查看：损失曲线（训练损失和验证损失）、准确率曲线、学习率变化、GPU 使用情况、训练速度等。SwanLab 还会自动记录所有配置参数，方便后续复现实验。您可以访问 SwanLab 网页版查看历史实验记录和对比不同实验的结果。

## 回测评估问题

### Q17：回测结果异常如何排查？

回测结果异常可能由多种原因引起。首先检查模型预测输出是否合理，预测值应该在 0 到 1 之间。其次确认数据加载是否正确，回测使用的数据应与测试集一致。第三检查回测参数配置，特别是初始资金、交易成本等设置。第四查看生成的累计收益率曲线，异常波动可能表示数据或逻辑问题。第五对比不同模型的回测结果，如果所有模型结果都异常，问题可能出在数据处理环节。

### Q18：回测结果与预期不符怎么办？

回测结果与预期不符是常见情况，可能的原因包括：策略本身效果不佳，建议尝试不同的模型或参数配置；回测参数设置过于理想化，如未考虑交易成本、滑点等；市场环境变化，历史表现不能代表未来；数据质量问题，检查数据是否完整准确。建议多次运行实验取平均结果，避免单次实验的偶然性。同时，建议在多个时间段上进行回测，验证策略的稳健性。

### Q19：如何比较不同模型的回测性能？

项目提供了统一的回测评估框架，您可以对不同模型运行相同的回测配置，然后比较结果文件中的各项指标。主要比较指标包括：年化收益率（ARR）表示策略的收益能力；夏普比率（SR）表示风险调整后的收益；最大回撤（MDD）表示策略的风险水平；信息比率（IR）表示相对于基准的超额收益。您可以手动比较结果文件，或使用 `utils/plot.py` 中的可视化功能对比不同模型的曲线。

### Q20：如何避免回测中的常见陷阱？

回测中存在多种可能导致结果偏高的陷阱。前视偏差是指使用了回测期间结束后才可得的信息进行预测，需要确保每个预测只使用该时点之前的数据。幸存者偏差是指只选择当前存在的股票进行回测，需要包含已退市或被收购的股票。交易成本模拟不足会导致回测结果过于理想化，建议使用实际交易成本数据。策略过拟合会导致在新数据上表现不佳，建议使用更长的回测时间段验证策略稳健性。流动性假设不现实可能导致大额交易无法实际执行，需要考虑市场容量限制。

## 其他问题

### Q21：如何查看详细的日志信息？

默认情况下，程序会输出基本的运行信息。如需查看更详细的日志，可以在运行命令时添加 `--verbose` 参数（如果支持）。对于深度学习框架的日志，可以通过设置环境变量 `PYTHONVERBOSE=1` 或在代码中配置日志级别来获取更多调试信息。训练过程中的详细损失值和中间结果会保存在 SwanLab 中，您可以登录 SwanLab 网页查看。

### Q22：如何贡献代码或报告问题？

如果您发现项目中的问题或有功能建议，欢迎通过 GitHub Issues 页面报告。报告问题时，请提供以下信息：操作系统的版本、Python 版本、完整的错误信息和堆栈跟踪、复现问题的步骤、已尝试的解决方法。项目接受 Pull Request 贡献代码，贡献前请阅读开发者指南中的代码规范和贡献流程。详细说明请参考贡献指南文档。

### Q23：项目使用的许可证是什么？

LightQuant 项目代码采用 MIT 许可证开源，这意味着您可以自由使用、修改和分发代码，但需要保留原始的版权声明。CSMD 数据集采用 Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) 许可证，这意味着数据集可以用于非商业目的，使用时需要署名并以相同方式共享。详细许可证内容请参考附录中的许可证文档。

### Q24：如何在项目中添加自定义模型？

添加自定义模型需要遵循项目的模块化设计原则。首先，在 `model/` 目录下创建新的模型文件，继承 `torch.nn.Module` 类并实现 `forward` 方法。然后，在 `run.py` 的模型加载部分添加对新模型的支持，或实现模型注册机制。接着，编写模型对应的数据加载器（如需要特殊的数据格式）。最后，在配置文件中添加模型的默认参数。详细步骤请参考自定义模型文档。

### Q25：模型预测结果不理想怎么办？

模型预测效果不理想可能由多种因素引起。数据方面，确保数据质量高、特征选择合理、标签定义正确。模型方面，尝试不同的模型架构或调整模型复杂度。参数方面，进行超参数调优，寻找最优配置。特征工程方面，添加更多有意义的特征或尝试特征组合。训练策略方面，尝试不同的优化器、学习率调度策略或正则化方法。建议系统性地进行实验，记录每个实验的配置和结果，逐步定位问题所在。
