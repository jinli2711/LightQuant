# 策略回测

本章节详细介绍 LightQuant 项目的回测框架和使用方法，包括回测原理、策略配置、评估指标和结果分析。回测是验证交易策略有效性的关键步骤，能够帮助研究者评估策略在历史数据上的表现。

## 回测框架概述

### 回测原理

回测（Backtesting）是使用历史数据模拟交易策略执行过程的方法。通过将策略的预测结果转化为交易信号，并在历史数据上模拟执行，可以评估策略在過去市場環境下的表现。LightQuant 的回测框架实现了完整的交易模拟流程，包括信号生成、订单执行、持仓管理和收益计算。

回测的价值在于：在实际资金投入前评估策略的潜在收益和风险；比较不同策略或参数配置的效果；识别策略设计中的问题和改进方向；建立对策略行为的直观理解。需要注意的是，回测结果不代表未来表现，历史业绩不能保证未来收益。

### 框架设计

LightQuant 的回测框架采用模块化设计，主要组件包括：信号生成模块，根据模型预测生成交易信号；订单执行模块，模拟订单的提交和成交；持仓管理模块，跟踪持仓状态和资金变化；收益计算模块，计算各项收益和风险指标；结果分析模块，汇总和可视化回测结果。

框架支持多种回测模式：单股票回测，针对单一股票进行策略回测；多股票回测，评估策略在多只股票上的综合表现；多模型对比，同时比较不同模型的回测效果。不同模式适用于不同的研究需求。

### 回测入口

回测的主入口脚本是 `backtest/run_backtest.py`。基本使用命令如下：`python backtest/run_backtest.py --dataset CSMD50 --model LSTM --use_news False --look_back_window 7 --model_save_folder ./result/CSMD50/model_saved/ --test_price_folder ./dataset/CSMD50/test/price/ --backtest_result_folder ./result/CSMD50/backtest_result/`。

此命令加载训练好的 LSTM 模型，在测试集数据上进行回测，并将结果保存到指定目录。回测完成后，会输出各项评估指标的平均值，并生成详细的结果文件。

## 交易策略

### 基本策略

LightQuant 实现了基于预测方向的简单交易策略：当模型预测下一日上涨（预测值 > 0.5）时，买入股票；当模型预测下一日下跌（预测值 <= 0.5）时，卖出或做空股票。策略假设每个交易日开盘时根据预测结果执行交易，收盘时计算当日盈亏。

策略的具体规则如下：初始资金设为 10000 元；每次交易买入或卖出 1 手（即 100 股，假设价格单位为元/股）；允许做空，即预测下跌时卖出持有的股票或先卖出再买入；不考虑交易滑点，成交价格假设为当日收盘价。

### 策略变体

项目支持策略的变体配置，主要区别在于对做空的态度：全向策略同时支持做多和做空，预测上涨时买入，预测下跌时卖出（或做空）；多头策略仅在预测上涨时买入，预测下跌时空仓观望。默认使用全向策略，如需切换为多头策略，需要修改 `backtest/backtest_single.py` 中的相关代码。

策略变体的选择取决于对市场的看法和对风险的承受能力：全向策略在下跌市场中也有机会获利，但承担了更多风险；多头策略在牛市中表现更好，但会在熊市中遭受损失。建议根据市场环境选择合适的策略，或使用资产配置方法同时应用多种策略。

### 策略参数

回测支持以下可配置参数：初始资金，设置回测开始时的资金总额；交易成本，设置每次交易的佣金费率，默认为 0（即不考虑佣金）；回看窗口，与模型训练保持一致，决定每次预测使用的历史数据长度。这些参数通过命令行参数或配置文件设置。

## 回测指标

### 年化收益率（ARR）

年化收益率（Annualized Return Rate，ARR）将策略的总收益转化为等效的年化收益率，便于不同时间长度的策略进行比较。计算公式为：ARR = (最终资产 / 初始资产)^(252/交易日天数) - 1。假设一年有 252 个交易日，将实际收益年化。

ARR 是评估策略收益能力的核心指标。ARR 为正表示策略在回测期间盈利；ARR 为负表示策略亏损。ARR 越高，策略的收益能力越强。但 ARR 不能反映策略的风险水平，需要结合风险指标综合评估。

### 夏普比率（SR）

夏普比率（Sharpe Ratio，SR）衡量策略的风险调整后收益，计算每承担一单位风险所获得的超额收益。计算公式为：SR = (策略年化收益率 - 无风险利率) / 策略年化波动率。无风险利率默认设置为 0.01（1%）。

夏普比率的解读如下：SR > 1 表示风险调整后收益良好；SR > 2 表示非常优秀的表现；SR < 0 表示策略表现不如无风险资产。夏普比率越高，说明投资者每承担一单位风险所获得的超额回报越多。

### 最大回撤（MDD）

最大回撤（Maximum Drawdown，MDD）衡量策略在最坏情况下从峰值到谷值的最大跌幅，反映策略的极端风险。计算公式为：MDD = max( (峰值 - 谷值) / 峰值 )，其中峰值和谷值是资产净值序列的局部最大和最小值。

MDD 是风险控制的重要指标。MDD 越大，表示策略可能遭受的最大损失越大。例如，MDD 为 25% 表示策略曾经在某个时候从高点下跌了四分之一。对于实际投资，这意味着需要准备足够的资金来应对最坏情况。

### Calmar 比率（CR）

Calmar 比率（Calmar Ratio，CR）将年化收益率与最大回撤结合，衡量每单位最大回撤获得的收益。计算公式为：CR = ARR / MDD。CR 越高，说明策略在控制回撤的同时实现了较好的收益。

Calmar 比率特别适用于评估需要控制下行风险的策略。较高的 Calmar 比率（通常 > 2）表示策略具有较好的风险收益特征。但需要注意，MDD 是历史最大回撤，未来可能突破这一水平。

### 信息比率（IR）

信息比率（Information Ratio，IR）衡量策略相对于基准的超额收益及其稳定性。计算公式为：IR = 超额收益均值 / 超额收益标准差。超额收益是策略收益与基准收益（通常取市场平均或指数收益）的差值。

IR 越高，说明策略获取超额收益的能力越稳定。IR 为正表示策略优于基准；IR 越大，策略的相对表现越好且越稳定。IR 常用于评估主动管理策略相对于被动指数投资的优劣。

### 累计收益率曲线

累计收益率曲线展示策略资产净值随时间的变化，是最直观的回测可视化结果。横轴为时间，纵轴为资产净值（初始值设为 1 或 100%）。曲线上升表示盈利，下降表示亏损，曲线的斜率表示收益率的快慢。

通过累计收益率曲线可以直观观察：策略的整体收益表现；收益实现的时间分布；回撤发生的时期和幅度；策略表现的稳定性。曲线通常与基准（如简单的买入持有策略）一起绘制，便于比较。

## 回测配置

### 基本配置

回测的基本配置通过命令行参数指定，主要包括：model 指定用于生成信号的模型名称；model_save_folder 指定训练好的模型权重路径；test_price_folder 指定测试集价格数据路径；backtest_result_folder 指定回测结果保存路径；GPU 相关参数如 useGPU 和 GPU_ID。

配置示例：`python backtest/run_backtest.py --dataset CSMD50 --model LSTM --model_save_folder ./result/CSMD50/model_saved/ --test_price_folder ./dataset/CSMD50/test/price/ --backtest_result_folder ./result/CSMD50/backtest_result/ --useGPU True --GPU_ID 0`。

### 交易成本设置

交易成本是回测中需要考虑的重要因素。虽然默认配置假设交易成本为 0，但实际交易中会产生佣金、印花税、滑点等成本。在 `backtest/backtest_single.py` 中可以调整 cost 参数来模拟交易成本的影响。

交易成本对策略表现的影响取决于交易频率：高频交易策略对交易成本更敏感，即使很小的成本也会显著侵蚀收益；低频策略对交易成本相对不敏感。在回测时使用更现实的成本假设，可以获得更可靠的策略评估结果。

### 多模型回测

项目支持同时对多个模型进行回测并比较结果。可以通过循环调用回测脚本或修改代码实现多模型批量回测。结果文件可以汇总到同一目录，使用 `utils/plot.py` 进行可视化对比。多模型回测有助于全面评估不同模型的实际交易效果。

## 回测结果分析

### 结果文件解读

回测完成后，会生成以下结果文件：模型名称.txt 包含各项指标的平均值；模型名称_cumulative_return.csv 包含每日的累计收益率数据。这些文件可用于后续分析和可视化。

结果文件的内容解读如下：指标文件包含 ACC、ARR、SR、MDD、CR、IR 的均值和方差；收益率文件包含每个交易日的累计收益率序列，可以用于绘制收益曲线和计算其他统计量。

### 结果可视化

使用 `utils/plot.py` 可以可视化回测结果。基本用法为：`python utils/plot.py --result_file ./result/CSMD50/backtest_result/LSTM_cumulative_return.csv --output_file ./result/CSMD50/backtest_result/figure/`。此命令根据累计收益率数据生成可视化图表。

可视化的分析要点包括：观察收益曲线的整体趋势和波动性；识别主要的盈利和亏损时段；比较不同模型或策略的曲线差异；分析曲线形态与市场环境的关系。

### 风险评估

通过回测结果进行风险评估时，需要关注以下方面：最大回撤的大小和持续时间；收益的波动性和分布；极端情况下的表现；策略表现与市场环境的关系。完整的风险评估还应包括压力测试和敏感性分析，测试策略在极端市场条件下的表现。

## 避免回测陷阱

### 前视偏差

前视偏差是最常见的回测陷阱之一，指在评估时使用了评估时点之后才可得的信息。例如，使用当日收盘后的数据来做出当日交易的决策。在真实交易中，这种信息在决策时点是不可得的。

避免前视偏差的方法包括：确保每个预测只使用该时点之前的历史数据；严格按时间顺序处理数据，后处理的数据不应影响先处理的决策；仔细检查数据加载和预测流程，确保没有信息泄露。

### 幸存者偏差

幸存者偏差指回测只包含当前仍存在的股票，而忽略了已经退市、被收购或破产的股票。这会导致评估结果偏向乐观，因为表现差的股票被排除在外。

避免幸存者偏差的方法包括：使用包含全部历史股票的数据集；在回测开始时获取完整的股票列表，包括后来退市的股票；注意 CSMD 数据集已经过处理，建议了解其股票选择标准。

### 过度拟合

过度拟合指策略参数过于针对历史数据的特点进行优化，导致在新数据上表现不佳。这在回测中很常见，因为研究者可能不断调整参数以获得更好的回测结果。

避免过度拟合的方法包括：使用验证集进行参数选择，而非直接使用测试集；限制参数调整的次数和范围；使用正则化或早停机制；进行样本外测试，验证策略在新数据上的表现。

### 交易成本和滑点

回测中忽略交易成本和滑点会导致收益高估。实际交易中，每次买卖都会产生佣金和印花税，大额交易还会导致价格变动（滑点），这些都会侵蚀收益。

避免此问题的方法包括：在回测中包含合理的交易成本假设；使用保守的滑点估计；进行敏感性分析，测试策略在不同成本假设下的表现；特别关注高频策略，成本影响更显著。

## 回测的局限性

### 历史不代表未来

回测结果基于历史数据，市场的运作规律可能随时间变化。过去的有效策略在未来可能失效，新的市场环境可能产生过去未出现的模式。使用回测结果时需要认识到这一根本局限。

### 市场流动性限制

回测通常假设任何规模的订单都能以假设价格成交，但实际市场中，大额订单可能导致价格变动或无法完全成交。对于需要实际部署的策略，需要考虑市场容量和流动性限制。

### 行为因素

回测忽略了实际交易中的行为因素，如心理压力、执行错误、市场冲击等。真实交易中，投资者可能因恐惧或贪婪而偏离策略，订单可能因技术故障而未能执行。这些因素都会影响实际表现。

## 后续步骤

回测完成后，可以进行以下操作：分析结果，识别策略的优势和不足；调整策略参数或设计进行优化；进行更严格的样本外测试；考虑实际部署时的工程实现细节；制定风险管理规则和头寸管理策略。
