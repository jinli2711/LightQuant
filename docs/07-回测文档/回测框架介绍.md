# 回测框架介绍

本章节详细介绍 LightQuant 项目的回测框架设计，帮助用户理解回测的原理、实现方式和使用方法。

## 回测概述

### 什么是回测

回测（Backtesting）是量化投资研究中的核心方法，指使用历史数据模拟执行交易策略，评估策略在历史市场环境下的表现。通过回测，研究者可以在实际投入资金前验证策略的有效性，识别策略的优势和不足。

回测的价值包括：策略验证，在真实交易前评估策略的潜在收益和风险；参数优化，通过回测结果调整策略参数；风险评估，了解策略的最大回撤和波动风险；心理建设，通过历史结果建立对策略的信心。

### 回测的局限性

回测结果不代表未来表现，这是使用回测时必须牢记的根本原则。回测的局限性包括：历史不代表未来，市场规律可能随时间变化；过度拟合风险，策略可能过度适应历史数据；忽略现实因素，如流动性、执行延迟、心理因素等；前视偏差风险，不当的实现可能导致结果虚高。

## 框架设计

### 整体架构

LightQuant 回测框架采用模块化设计，主要组件包括：数据加载模块，加载测试集数据并生成模型输入；模型推理模块，使用训练好的模型生成预测信号；交易模拟模块，根据预测信号模拟交易执行；收益计算模块，计算策略的收益和风险指标；结果输出模块，汇总并保存回测结果。

### 数据流

回测的数据流如下：加载测试集价格数据；为每个时间步准备输入特征；使用模型预测下一日涨跌概率；根据预测结果生成交易信号；模拟交易执行，更新持仓状态；计算每日资产净值；汇总整个回测期间的指标。

### 关键类和方法

backtest_single.py 中的主要函数：backtest_normal() 用于普通模型的回测；backtest_dtml() 用于 DTML 模型的回测；backtest_scinet() 用于 SCINet 模型的回测；backtest_single() 主函数，协调整个回测流程。

## 交易模拟

### 交易规则

LightQuant 的回测采用以下交易规则：初始资金设为 10,000 元（可配置）；每次买入或卖出 1 手（100 股）股票；预测值 > 0.5 买入或持有；预测值 <= 0.5 卖出或做空；成交价格假设为当日收盘价；不考虑交易滑点；允许做空。

### 做空机制

默认策略允许做空，即在预测下跌时卖出持有的股票或先卖出再买入。做空机制使策略在下跌市场中也有机会获利，但也承担了更多风险。如果不希望做空，可以修改回测代码中的相关逻辑。

### 持仓管理

持仓管理规则：多头持仓（stock > 0）表示持有股票；空头持仓（stock < 0）表示做空；stock = 0 表示空仓；每次交易调整 stock 到目标值（+1 或 -1）。

### 资金计算

资金计算公式：现金变化 = 交易方向 × (价格 × 交易量 + 价格 × 交易成本)；资产净值 = 现金 + 股票数量 × 当前价格；初始净值归一化为 1.0。

## 策略类型

### 全向策略

全向策略同时支持做多和做空：预测上涨时买入（stock = 1）；预测下跌时卖出或做空（stock = -1）。这种策略在牛市和熊市中都有机会获利。

### 多头策略

多头策略只在预测上涨时买入：预测上涨时买入（stock = 1）；预测下跌时空仓（stock = 0）。这种策略在牛市中表现较好，但在熊市中会空仓观望。

### 策略切换

要切换策略类型，需要修改 backtest_single.py 中的相关逻辑。找到交易信号生成部分，将条件判断从做空改为空仓即可。

## 回测指标

### 准确率（ACC）

分类准确率表示预测正确的比例。计算方法：ACC = 预测正确数 / 总样本数。准确率是评估预测模型的基本指标，但不反映收益和风险。

### 年化收益率（ARR）

年化收益率将策略总收益转化为年化标准，便于不同时间长度的策略比较。计算公式：ARR = (最终净值 / 初始净值)^(252/交易日天数) - 1。

### 夏普比率（SR）

夏普比率衡量风险调整后收益。计算公式：SR = (策略年化收益 - 无风险利率) / 策略年化波动率。SR > 1 表示风险调整后收益良好。

### 最大回撤（MDD）

最大回撤衡量最坏情况下的回撤幅度。计算公式：MDD = max((峰值 - 谷值) / 峰值)。MDD 越大表示极端风险越大。

### Calmar 比率（CR）

Calmar 比率综合考虑收益和回撤。计算公式：CR = ARR / MDD。CR 越高表示每单位回撤获得的收益越高。

### 信息比率（IR）

信息比率衡量相对于无风险资产的超额收益。计算公式：IR = 超额收益均值 / 超额收益标准差。

## 使用方法

### 基本使用

使用训练好的模型进行回测：`python backtest/run_backtest.py --dataset CSMD50 --model LSTM --use_news False --look_back_window 7 --model_save_folder ./result/CSMD50/model_saved/ --test_price_folder ./dataset/CSMD50/test/price/ --backtest_result_folder ./result/CSMD50/backtest_result/`

### 关键参数

model_save_folder 训练好的模型权重路径。test_price_folder 测试集价格数据路径。backtest_result_folder 回测结果保存路径。batch_size 批量大小，影响回测速度。useGPU 是否使用 GPU。

### 结果解读

回测完成后会输出：各指标的平均值（多股票回测）；结果文件的保存路径。结果文件包括：指标汇总文件（.txt）；累计收益率数据（.csv）。

## 多模型对比

### 运行多模型回测

要对比多个模型，可以分别对每个模型运行回测，然后比较结果。或者修改 backtest_multi.py 实现批量回测。

### 结果对比

对比不同模型的回测结果时，应关注：各模型的核心指标（ARR、SR、MDD）；指标的一致性和稳定性；不同市场环境下的表现差异；计算效率对比。

## 常见问题

### 回测结果异常

如果回测结果异常（如 ARR 过高或过低），可能的原因：模型预测全是 1 或全是 0；数据格式错误；模型未正确加载；回测代码逻辑错误。

### 指标为 NaN

如果某些指标显示 NaN，可能的原因：资产序列长度不足（至少需要 2 个数据点）；所有收益为 0 导致标准差为 0；数据中存在异常值。建议检查原始数据和回测配置。

### 收益与预期不符

如果回测收益与预期差距较大，可能的原因：策略本身效果不佳；交易成本假设过于理想化；市场环境与训练数据差异较大。建议进行参数敏感性分析。

## 最佳实践

### 避免常见陷阱

使用回测时应避免：前视偏差，确保预测只使用历史数据；过度拟合，避免对历史数据过度优化；忽略交易成本，使用更现实的成本假设；幸存者偏差，确保包含全部历史股票。

### 结果验证

建议对回测结果进行：样本外测试，使用训练集之后的数据验证；参数稳定性测试，改变参数观察结果变化；敏感性分析，测试关键假设变化的影响；压力测试，模拟极端市场环境。

### 记录和复现

每次回测应记录：模型版本和配置；回测时间段；所有参数设置；随机种子；结果摘要。这些记录对于复现实验和比较结果至关重要。
