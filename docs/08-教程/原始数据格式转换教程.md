# 数据转换详细步骤文档

## 1. 项目概述

本项目是CSMD（Curated Multimodal Dataset for Chinese Stock Analysis），一个用于中国股票分析的多模态数据集，包含股票价格和金融新闻文本数据。本文档详细说明如何将通过脚本获取的原始数据转换为项目所需的标准格式。

## 2. 原始数据格式

通过脚本获取的原始数据保存在以下位置：

### 2.1 股价数据
- 位置：`data/A_Stocks_Data/`
- 文件名：以股票代码命名，如 `sh.600028.csv`
- 格式：CSV文件，包含以下字段：
  ```
  date,code,open,high,low,close,preclose,volume,amount,adjustflag,turn,tradestatus,pctChg,peTTM,pbMRQ,psTTM,pcfNcfTTM,isST,code_name,industry,industryClassification
  ```

### 2.2 新闻数据
- 位置：`news/`
- 文件名：以股票代码命名，如 `sh.600028.json`
- 格式：JSON文件，包含以下字段：
  ```json
  [
    {
      "time": "2026-01-12 09:51",
      "title": "石油化工板块盘初下挫 中国石化跌超3%",
      "content": "...",
      "link": "https://www.stcn.com/..."
    }
  ]
  ```

## 3. 目标数据格式

转换后的标准数据保存在 `dataset/CSMD50/` 目录下：

### 3.1 股价数据
- 位置：`dataset/CSMD50/price/`
- 文件名：以股票名称命名，如 `中国石化.csv`
- 格式：CSV文件，包含以下字段：
  ```
  Date,Open,High,Low,Close,Adj Close,Volume
  ```

### 3.2 新闻数据
- 位置：`dataset/CSMD50/news/`
- 目录结构：按股票名称分目录，如 `dataset/CSMD50/news/中国石化/`
- 文件名：以日期命名，如 `2024-01-01.csv`
- 格式：CSV文件，包含以下字段：
  ```
  code_name,ticker,created_at,text
  ```

## 4. 数据转换流程

### 4.1 依赖文件

- 股票代码与名称映射表：`dataset_construction/Corrected_CSV_File_Last_Date_Summary.csv`
- 数据转换脚本：`dataset_construction/convert_data_format.py`（已提供）

### 4.2 转换步骤

1. **准备数据**：确保原始数据已正确获取并保存在指定目录
2. **运行转换脚本**：执行数据转换脚本，将原始数据转换为标准格式
3. **验证转换结果**：检查转换后的数据格式是否符合要求

## 5. 转换脚本说明

### 5.1 脚本功能

`dataset_construction/convert_data_format.py` 脚本负责：

- 将股价数据从 `data/A_Stocks_Data/` 转换到 `dataset/CSMD50/price/`
- 将新闻数据从 `news/` 转换到 `dataset/CSMD50/news/`
- 自动处理股票代码与名称的映射
- 确保转换后的数据格式符合标准

### 5.2 脚本结构

```python
# 转换股价数据
def convert_price_data():
    # ...

# 转换新闻数据
def convert_news_data():
    # ...

# 主函数
def main():
    # ...
```

## 6. 运行步骤

### 6.1 环境准备

确保已安装必要的Python库：

```bash
pip install pandas
```

### 6.2 执行转换

在项目根目录下执行以下命令：

```bash
# 进入数据构建目录
cd dataset_construction

# 运行转换脚本
python convert_data_format.py
```

### 6.3 预期输出

成功运行后，将看到类似以下输出：

```
============================================================
开始数据转换流程
============================================================
开始转换股价数据...
已转换股价数据：sh.600028.csv -> 中国石化.csv
已转换股价数据：sh.600030.csv -> 中信证券.csv
...
股价数据转换完成，共处理 50 个文件

开始转换新闻数据...
已转换新闻数据：sh.600028.json -> 中国石化/ (共 151 个日期)
已转换新闻数据：sh.600030.json -> 中信证券/ (共 52 个日期)
...
新闻数据转换完成，共处理 50 个文件

============================================================
数据转换全部完成！
============================================================
股价数据已保存到：dataset/CSMD50/price/
新闻数据已保存到：dataset/CSMD50/news/
```

## 7. 验证转换结果

### 7.1 验证股价数据

检查 `dataset/CSMD50/price/` 目录下的文件：

```bash
# 查看股价数据文件列表
ls dataset/CSMD50/price/

# 查看文件内容
head -10 dataset/CSMD50/price/中国石化.csv
```

预期输出：

```
Date,Open,High,Low,Close,Adj Close,Volume
2019-01-02,5.1000,5.1100,4.9600,5.0100,5.0100,218558370
2019-01-03,5.0300,5.0500,4.9600,5.0400,5.0400,154788484
...
```

### 7.2 验证新闻数据

检查 `dataset/CSMD50/news/` 目录下的文件：

```bash
# 查看新闻数据目录结构
ls dataset/CSMD50/news/中国石化/

# 查看文件内容
head -10 dataset/CSMD50/news/中国石化/2024-01-01.csv
```

预期输出：

```
code_name,ticker,created_at,text
中国石化,sh.600028,2024-01-01,...
...
```

## 8. 注意事项

1. **数据完整性**：确保原始数据完整，避免转换失败
2. **文件名一致性**：确保股票代码与名称映射表 `Corrected_CSV_File_Last_Date_Summary.csv` 中的股票代码与原始数据文件名一致
3. **路径问题**：转换脚本必须在 `dataset_construction` 目录下运行
4. **覆盖问题**：转换脚本会覆盖已存在的目标文件，请确保目标目录下没有需要保留的重要文件
5. **编码问题**：确保所有文件使用UTF-8编码

## 9. 后续步骤

数据转换完成后，可以继续进行以下操作：

1. 使用LLM从新闻中提取金融因子：
   ```bash
   python ./llm_factor/extract_factors.py
   ```

2. 生成新闻文本的Word2Vec嵌入：
   ```bash
   python ./utils/word2vec.py
   ```

3. 数据集处理与分割：
   ```bash
   python ./utils/util.py
   ```

4. 模型训练与评估：
   ```bash
   python run.py
   ```

## 10. 故障排除

### 10.1 常见错误

1. **文件路径错误**
   - 确保脚本在 `dataset_construction` 目录下运行
   - 检查原始数据目录是否存在

2. **缺少依赖库**
   - 确保已安装所有必要的Python库
   - 运行 `pip install pandas` 安装pandas

3. **编码错误**
   - 确保所有文件使用UTF-8编码
   - 检查CSV文件的编码格式

4. **股票代码不匹配**
   - 确保 `Corrected_CSV_File_Last_Date_Summary.csv` 中包含所有原始数据的股票代码
   - 检查股票代码格式是否正确

## 11. 联系方式

如有问题，请联系项目维护人员。

---

**版本**：v1.0  
**更新日期**：2026-01-22  
**作者**：CSMD项目组
