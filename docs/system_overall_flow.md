# 系统总体流程

## 1. 系统架构概述

LightQuant是一个基于深度学习的股票预测系统，结合了价格数据和新闻数据进行股票价格预测。系统主要分为数据收集、数据处理、因素提取、模型训练和评估等几个核心模块。

## 2. 系统完整流程

### 2.1 数据收集与构建流程

#### 2.1.1 股价数据收集

**流程描述**：从Baostock金融数据平台获取股票历史价格数据，包括上证50成分股的日K线数据。

**代码文件**：`dataset_construction/price_data_collection.py`

**输入**：
- 起始日期（如："2019-01-01"）
- 结束日期（如："2024-12-18"）
- 当前日期（如："2024-12-19"）
- 股票数量（默认：10000）

**输出**：
- 单个股票的CSV文件，存储在`data/A_Stocks_Data/`目录下
- 文件命名格式：`{股票代码}.csv`
- 包含字段：日期、开盘价、最高价、最低价、收盘价、成交量等

#### 2.1.2 新闻数据抓取

**流程描述**：使用Selenium和BeautifulSoup从新闻网站抓取股票相关新闻。

**代码文件**：`dataset_construction/news_scraper.py`

**输入**：
- 股票代码列表
- 时间范围

**输出**：
- JSON格式的新闻文件，存储在指定目录下
- 包含字段：时间、标题、内容等

### 2.2 新闻因素提取流程

**流程描述**：使用大语言模型从新闻中提取影响股价的前3个因素，为后续模型训练提供新闻特征。

**代码文件**：`llm_factor/extract_factors.py`

**输入**：
- 原始新闻JSON文件
- 股票代码与名称映射CSV文件（如：`CSMD50.csv`）
- 大语言模型路径

**输出**：
- 包含每日影响因素的CSV文件，存储在指定输出目录
- 文件命名格式：`{股票代码}_factors.csv`
- 包含字段：日期、top1、top2、top3（三个影响因素）

### 2.3 模型训练与评估流程

#### 2.3.1 主入口流程

**流程描述**：系统主入口，负责解析命令行参数并调用相应的评估函数。

**代码文件**：`run.py`

**输入**：
- 命令行参数，包括数据集、模型类型、训练参数等

**输出**：
- 模型训练结果
- 测试结果
- 可视化图表

#### 2.3.2 单因子模型评估

**流程描述**：仅使用价格数据进行模型训练和评估。

**代码文件**：`eval_single.py`

**输入**：
- 命令行参数对象

**输出**：
- 模型训练结果
- 测试结果

#### 2.3.3 多因子模型评估

**流程描述**：结合价格数据和新闻因素进行模型训练和评估，支持多种模型架构。

**代码文件**：`eval_multi.py`

**输入**：
- 命令行参数对象

**输出**：
- 模型训练结果
- 测试结果

## 3. 模块间依赖关系

```
┌─────────────────────┐     ┌─────────────────────┐
│ 股价数据收集模块    │────▶│ 新闻数据抓取模块    │
│ (price_data_collection.py) │     │ (news_scraper.py) │
└─────────────────────┘     └─────────────────────┘
          │                           │
          ▼                           ▼
┌─────────────────────┐     ┌─────────────────────┐
│ 数据存储目录        │     │ 新闻因素提取模块    │
│ (data/A_Stocks_Data/) │     │ (extract_factors.py) │
└─────────────────────┘     └─────────────────────┘
          │                           │
          └───────────────┬───────────┘
                          ▼
┌─────────────────────────────────────────┐
│                 模型训练与评估模块       │
│ (run.py ──▶ eval_single.py/eval_multi.py) │
└─────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────┐
│                 结果输出目录             │
│ (result/{dataset}/model_saved/,         │
│  result/{dataset}/figure/,              │
│  result/{dataset}/test_result/)         │
└─────────────────────────────────────────┘
```

## 4. 关键流程详解

### 4.1 新闻因素提取详细流程

1. **加载股票名称映射**：从CSV文件加载股票代码和名称的映射关系
2. **加载新闻数据**：从JSON文件加载原始新闻数据
3. **按日期分组新闻**：将新闻按日期进行分组，便于每日分析
4. **构建每日提示**：为每个日期的新闻构建LLM提示，要求提取影响股价的前3个因素
5. **生成模型响应**：使用LLM生成新闻分析结果
6. **解析响应**：从模型响应中提取结构化的影响因素
7. **保存结果**：将提取的因素保存到CSV文件中

### 4.2 模型训练详细流程

1. **初始化参数**：解析命令行参数，设置随机种子
2. **登录SwanLab**：初始化实验跟踪系统
3. **选择模型类型**：根据参数选择单因子或多因子模型
4. **训练模型**：
   - 加载训练数据
   - 构建模型
   - 训练模型并保存
5. **测试模型**：
   - 加载测试数据
   - 使用训练好的模型进行预测
   - 评估模型性能
6. **保存结果**：
   - 模型文件
   - 可视化图表
   - 测试结果

## 5. 数据流向

```
原始数据 ──▶ 数据收集模块 ──▶ 原始数据存储 ──▶ 数据处理/特征提取 ──▶ 特征数据 ──▶ 模型训练 ──▶ 模型文件 ──▶ 模型测试 ──▶ 结果输出
```

## 6. 关键技术栈

| 模块 | 主要技术/库 |
|------|-------------|
| 数据收集 | Baostock, Selenium, BeautifulSoup |
| 数据处理 | Pandas, NumPy |
| 新闻因素提取 | vLLM, Transformers, 大语言模型 |
| 模型训练 | PyTorch, SwanLab |
| 模型架构 | LSTM, BiLSTM, SCINet, StockNet, HAN, PEN |

## 7. 运行流程示例

### 7.1 数据收集阶段

1. 运行股价数据收集脚本：
   ```bash
   python dataset_construction/price_data_collection.py
   ```

2. 运行新闻数据抓取脚本：
   ```bash
   python dataset_construction/news_scraper.py
   ```

### 7.2 特征提取阶段

3. 运行新闻因素提取脚本：
   ```bash
   python llm_factor/extract_factors.py --model_path your_model_path --tokenizer_path your_tokenizer_path --dataset CSMD50 --original_news_path your_news_path --output_news_path your_output_path
   ```

### 7.3 模型训练与评估阶段

4. 运行主程序进行模型训练和评估：
   ```bash
   python run.py --dataset CSMD50 --model HAN --use_news True --epochs 300
   ```

## 8. 结果输出

系统运行完成后，结果将输出到以下目录：

- **模型文件**：`result/{dataset}/model_saved/`
- **可视化图表**：`result/{dataset}/figure/`
- **测试结果**：`result/{dataset}/test_result/`

## 9. 系统扩展点

1. **支持更多股票**：修改`price_data_collection.py`中的股票选择逻辑
2. **支持更多模型**：在`multi_exp/train.py`和`multi_exp/test.py`中添加新模型实现
3. **优化新闻抓取**：扩展`news_scraper.py`支持更多新闻源
4. **改进因素提取**：调整`extract_factors.py`中的提示词或模型参数
5. **增加评估指标**：在评估模块中添加更多模型性能指标

## 10. 系统依赖关系

系统各模块之间的依赖关系如下：

- `run.py` 依赖 `eval_single.py` 和 `eval_multi.py`
- `eval_single.py` 依赖 `single_exp/train.py` 和 `single_exp/test.py`
- `eval_multi.py` 依赖 `multi_exp/train.py` 和 `multi_exp/test.py`
- 模型训练模块依赖 `factor_lib/` 中的因子库
- `extract_factors.py` 依赖大语言模型和新闻数据

## 11. 总结

LightQuant系统实现了从数据收集、特征提取到模型训练和评估的完整流程，结合了价格数据和新闻数据进行股票预测。系统采用模块化设计，便于扩展和维护，支持多种模型架构和评估方式。通过大语言模型提取新闻中的关键影响因素，提高了模型的预测能力。